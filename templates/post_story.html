{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="post-container">
        <div class="post-card">
            <h2>Tulis Curhatan Baru</h2>
            <form method="POST" action="{{ url_for('edit_story', story_id=story.id) if story else url_for('post_story') }}" enctype="multipart/form-data" id="story-form">
                <div class="form-group">
                    <label for="content">Ceritakan keluh kesahmu...</label>
                    <textarea id="content" name="content" rows="8" placeholder="Tulis cerita atau keluh kesahmu di sini..." required>{{ story.content if story else '' }}</textarea>
                    <div class="char-counter">
                        <span id="char-count">0</span>/1000 karakter
                    </div>
                </div>
                
                <!-- Image Upload Section -->
                <div class="form-group">
                    <label for="image">Upload Gambar (Opsional)</label>
                    <div class="image-upload-container">
                        <input type="file" id="image" name="image" accept="image/*" class="image-input">
                        <label for="image" class="image-upload-btn">
                            <i class="fas fa-cloud-upload-alt"></i>
                            Pilih Gambar
                        </label>
                        <div class="image-preview" id="image-preview">
                            {% if story and story.image_url %}
                            <div class="preview-item">
                                <img src="{{ url_for('static', filename=story.image_url) }}" alt="Preview">
                                <button type="button" class="remove-image" onclick="toggleRemoveExistingImage()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <small class="form-text">Format: JPG, PNG, GIF (Max: 5MB)</small>
                </div>
                
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="is_anonymous" name="is_anonymous" {% if story and story.is_anonymous %}checked{% endif %}>
                    <label for="is_anonymous">Posting sebagai Anonymous</label>
                </div>

                {% if story and story.image_url %}
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="remove_image" name="remove_image">
                    <label for="remove_image">Hapus gambar yang ada</label>
                </div>
                {% endif %}
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">{% if story %}Simpan Perubahan{% else %}Posting Curhatan{% endif %}</button>
                    <a href="{{ url_for('index') }}" class="btn btn-secondary">Batal</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Character counter
const contentTextarea = document.getElementById('content');
const charCount = document.getElementById('char-count');

contentTextarea.addEventListener('input', function() {
    const length = this.value.length;
    charCount.textContent = length;
    
    if (length > 1000) {
        charCount.style.color = 'var(--error-color)';
    } else {
        charCount.style.color = 'var(--text-secondary)';
    }
});

// Image Preview Functionality
document.getElementById('image').addEventListener('change', function(e) {
    const preview = document.getElementById('image-preview');
    const file = e.target.files[0];
    
    if (file) {
        if (file.size > 5 * 1024 * 1024) { // 5MB limit
            alert('Ukuran file terlalu besar! Maksimal 5MB.');
            this.value = '';
            preview.innerHTML = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `
                <div class="preview-item">
                    <img src="${e.target.result}" alt="Preview">
                    <button type="button" class="remove-image" onclick="removeImage()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        }
        reader.readAsDataURL(file);
    }
});

function removeImage() {
    document.getElementById('image').value = '';
    document.getElementById('image-preview').innerHTML = '';
}

function toggleRemoveExistingImage() {
    const removeCheckbox = document.getElementById('remove_image');
    if (removeCheckbox) {
        removeCheckbox.checked = !removeCheckbox.checked;
        // Visual feedback: if checked, hide existing preview
        const preview = document.getElementById('image-preview');
        if (removeCheckbox.checked) {
            preview.innerHTML = '';
        } else {
            // reload the existing image preview from server
            {% if story and story.image_url %}
            preview.innerHTML = `
                <div class="preview-item">
                    <img src="{{ url_for('static', filename=story.image_url) }}" alt="Preview">
                    <button type="button" class="remove-image" onclick="toggleRemoveExistingImage()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            {% endif %}
        }
    }
}

// Form validation
document.getElementById('story-form').addEventListener('submit', function(e) {
    const content = document.getElementById('content').value;
    
    if (content.length > 1000) {
        e.preventDefault();
        alert('Konten terlalu panjang! Maksimal 1000 karakter.');
        return;
    }
    
    if (content.trim().length === 0) {
        e.preventDefault();
        alert('Konten tidak boleh kosong!');
        return;
    }
});
// Initialize character counter based on textarea value (useful for edit)
document.addEventListener('DOMContentLoaded', function() {
    const contentEl = document.getElementById('content');
    const charCountEl = document.getElementById('char-count');
    if (contentEl && charCountEl) {
        charCountEl.textContent = contentEl.value.length;
    }
});
</script>
{% endblock %}